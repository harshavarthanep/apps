<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExamReady Pro v5 | Camera & Smart Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --danger: #ef4444;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1100px; margin: 0 auto; display: flex; gap: 20px; }
        
        /* Columns */
        .main-col { flex: 3; min-width: 0; }
        .sidebar { flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; height: fit-content; min-width: 250px; }

        /* Header */
        header { border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab-btn { background: var(--card); border: 1px solid var(--border); color: var(--text-muted); padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .tab-btn:hover { border-color: var(--primary); color: white; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Input Zones */
        .input-zone { display: none; animation: fadeIn 0.3s ease; }
        .input-zone.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        textarea { width: 100%; height: 180px; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 15px; resize: vertical; box-sizing: border-box; font-size: 1rem; }
        
        /* Camera UI */
        .camera-container { position: relative; background: black; border-radius: 8px; overflow: hidden; text-align: center; border: 2px solid var(--border); }
        video { width: 100%; max-height: 400px; display: block; }
        .camera-controls { padding: 10px; background: #000; display: flex; justify-content: center; gap: 10px; }

        /* Workspace */
        .workspace { margin-top: 30px; display: none; }
        .content-display { background: var(--card); padding: 25px; border-radius: 10px; border: 1px solid var(--border); white-space: pre-wrap; font-size: 1.1rem; line-height: 1.8; }

        /* Terms */
        .term { border-bottom: 2px solid var(--primary); font-weight: 600; cursor: pointer; color: #a5b4fc; transition: 0.2s; padding: 0 2px; }
        .blur-active .term { background: #475569; color: transparent; border: none; user-select: none; }
        .blur-active .term:hover { background: var(--success); color: white; cursor: help; }

        /* Controls */
        .controls { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        button { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; background: var(--primary); color: white; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.secondary { background: var(--card); border: 1px solid var(--border); }
        button.danger { background: var(--danger); }

        /* Quiz */
        .quiz-section { margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px; display: none; }
        .quiz-card { background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .option-btn { display: block; width: 100%; text-align: left; padding: 12px; margin-top: 8px; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .option-btn:hover { border-color: var(--primary); }
        .option-btn.correct { border-color: var(--success); background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .option-btn.wrong { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        /* Sidebar & Misc */
        .session-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .session-item:hover { background: rgba(255, 255, 255, 0.05); }
        .loader { display: none; color: var(--primary); margin-top: 10px; font-weight: 600; text-align: center; padding: 20px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; }

        /* Responsive */
        @media (max-width: 800px) { .container { flex-direction: column; } .sidebar { width: 100%; } }
    </style>
</head>
<body>

<div class="container">
    <div class="main-col">
        <header>
            <h1>ExamReady Pro <span style="font-size:0.5em; vertical-align:middle; background:var(--success); padding:2px 6px; border-radius:4px; color:black;">v5</span></h1>
            <p style="color: var(--text-muted)">Extract text from URLs, PDFs, Images, or Camera.</p>
        </header>

        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('paste', this)">üìù Text / Paste</div>
            <div class="tab-btn" onclick="switchTab('upload', this)">üìÇ Upload File</div>
            <div class="tab-btn" onclick="switchTab('camera', this)">üì∑ Camera (OCR)</div>
            <div class="tab-btn" onclick="switchTab('url', this)">üîó Website Link</div>
        </div>

        <div id="paste" class="input-zone active">
            <textarea id="inputText" placeholder="Paste your study notes here..."></textarea>
        </div>

        <div id="upload" class="input-zone">
            <div style="border: 2px dashed var(--border); padding: 40px; text-align: center; border-radius: 10px; cursor: pointer; position: relative;" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*, .pdf, .txt" style="display:none">
                <p style="font-size:1.2rem">Click to Upload PDF or Image</p>
                <p style="color:var(--text-muted)">Supports .pdf, .png, .jpg, .txt</p>
            </div>
        </div>

        <div id="camera" class="input-zone">
            <div class="camera-container">
                <video id="videoFeed" autoplay playsinline></video>
                <canvas id="canvas" style="display:none;"></canvas>
                <div class="camera-controls">
                    <button onclick="startCamera()">‚ñ∂ Start Camera</button>
                    <button onclick="capturePhoto()" class="danger">‚óâ Capture & Read</button>
                </div>
            </div>
            <p style="text-align:center; color:var(--text-muted); margin-top:10px;">Ensure good lighting and hold text steady.</p>
        </div>

        <div id="url" class="input-zone">
            <div style="display:flex; gap:10px;">
                <input type="text" id="urlInput" placeholder="https://en.wikipedia.org/wiki/Science" style="flex:1; padding:12px; border-radius:6px; border:1px solid var(--border); background:var(--card); color:white;">
                <button onclick="fetchUrl()">Fetch</button>
            </div>
            <p style="font-size:0.9rem; color:var(--danger); margin-top:10px;">
                <strong>Note:</strong> Many sites (NYTimes, Medium, etc.) block external tools. If this fails, please copy-paste the text manually.
            </p>
        </div>

        <div id="loader" class="loader">‚è≥ Processing... This is done locally on your device.</div>

        <div class="controls">
            <button onclick="processText()">‚ö° Analyze Text</button>
            <button class="secondary" onclick="toggleBlur()" id="blurBtn" disabled>üëÅÔ∏è Toggle Recall</button>
            <button class="secondary" onclick="generateQuiz()" id="quizBtn" disabled>‚ùì Generate Quiz</button>
            <button class="secondary" onclick="saveSession()" id="saveBtn" disabled>üíæ Save</button>
        </div>

        <div id="workspace" class="workspace">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                <strong style="color:var(--primary); font-size:1.2rem;">Study Mode</strong>
                <span id="modeBadge" style="font-size:0.8rem; background:var(--border); padding:4px 10px; border-radius:20px;">Reading</span>
            </div>
            
            <div id="displayText" class="content-display"></div>

            <div id="quizSection" class="quiz-section">
                <h2 style="color:var(--primary)">üß† Smart Quiz</h2>
                <div id="quizContainer"></div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <h3>Saved Sessions</h3>
        <div id="sessionList"></div>
    </div>
</div>

<script>
    // --- Global State ---
    let facts = [];
    let isBlurred = false;
    let videoStream = null;

    // --- Tab Switching ---
    function switchTab(id, btn) {
        document.querySelectorAll('.input-zone').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(btn) btn.classList.add('active');
        
        // Stop camera if leaving camera tab
        if(id !== 'camera' && videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    }

    // --- 1. Camera Logic ---
    async function startCamera() {
        try {
            const video = document.getElementById('videoFeed');
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = videoStream;
        } catch (err) {
            alert("Camera access denied or unavailable: " + err.message);
        }
    }

    async function capturePhoto() {
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('canvas');
        if (!videoStream) return alert("Start camera first!");

        // Draw video frame to canvas
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        // Stop camera to save battery
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;

        showLoader("Reading text from photo...");

        try {
            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            const { data } = await worker.recognize(canvas);
            await worker.terminate();
            
            if(!data.text.trim()) throw new Error("No text found in image.");
            
            document.getElementById('inputText').value = data.text;
            hideLoader();
            switchTab('paste', document.querySelectorAll('.tab-btn')[0]);
            alert("Text extracted! Click 'Analyze Text' to study.");
        } catch (err) {
            hideLoader();
            alert("OCR Failed: " + err.message);
        }
    }

    // --- 2. URL Fetching ---
    async function fetchUrl() {
        const url = document.getElementById('urlInput').value;
        if (!url) return alert("Enter a URL");
        showLoader("Fetching content...");

        try {
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            const res = await fetch(proxyUrl);
            const data = await res.json();
            
            if (!data.contents) throw new Error("Blocked by website security.");

            const doc = new DOMParser().parseFromString(data.contents, "text/html");
            // Remove junk
            ['script', 'style', 'nav', 'footer', 'iframe', 'svg'].forEach(tag => {
                doc.querySelectorAll(tag).forEach(el => el.remove());
            });

            const cleanText = doc.body.innerText.replace(/\s+/g, ' ').trim();
            if(cleanText.length < 50) throw new Error("Couldn't extract main text. Try manual copy-paste.");

            document.getElementById('inputText').value = cleanText;
            hideLoader();
            switchTab('paste', document.querySelectorAll('.tab-btn')[0]);

        } catch (err) {
            hideLoader();
            alert("Error: " + err.message + "\n\nTip: Use 'Reader Mode' in your browser, then copy-paste the text.");
        }
    }

    // --- 3. File Upload (PDF/Image) ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        showLoader("Processing file...");
        
        try {
            let text = "";
            if(file.type === 'application/pdf') {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    text += (await page.getTextContent()).items.map(s => s.str).join(" ") + "\n";
                }
            } else if(file.type.startsWith('image/')) {
                const worker = await Tesseract.createWorker();
                await worker.loadLanguage('eng');
                await worker.initialize('eng');
                text = (await worker.recognize(file)).data.text;
                await worker.terminate();
            } else {
                text = await file.text();
            }
            document.getElementById('inputText').value = text;
            hideLoader();
            switchTab('paste', document.querySelectorAll('.tab-btn')[0]);
        } catch(err) {
            hideLoader();
            alert("File Error: " + err.message);
        }
    });

    // --- 4. Analysis & Smart Quiz Logic ---
    function processText() {
        const rawText = document.getElementById('inputText').value;
        if(rawText.length < 20) return alert("Text is too short to analyze.");
        
        const display = document.getElementById('displayText');
        facts = []; // Reset facts
        
        // Split into sentences
        const sentences = rawText.match(/[^.!?]+[.!?]+/g) || [rawText];
        let htmlBuilder = "";

        // Improved Regex: Matches Years (1000-2999) OR Percentages OR Capitalized Words (Proper Nouns)
        const regex = /(\b(1[0-9]{3}|20[0-2][0-9])\b|\d+(?:\.\d+)?%|\b[A-Z][a-z]+(?:\s[A-Z][a-z]+)*)/g;

        sentences.forEach(sentence => {
            let tempSentence = sentence;
            
            // Find matches in this sentence
            const matches = [...sentence.matchAll(regex)];
            
            matches.forEach(m => {
                const val = m[0];
                const index = m.index;
                
                // Filter basic words
                if(["The", "This", "That", "It", "He", "She", "They", "But", "And", "In", "On", "Of", "For"].includes(val)) return;
                
                // Determine Type for Smart Quiz
                let type = 'text';
                if(val.match(/^\d{4}$/)) type = 'year';
                else if(val.includes('%')) type = 'percent';
                else if(!isNaN(parseFloat(val))) type = 'number';

                facts.push({ value: val, type: type, sentence: sentence });
            });

            // Highlight in HTML
            tempSentence = tempSentence.replace(regex, (match) => {
                 if(["The", "This", "That", "It", "He", "She", "They"].includes(match)) return match;
                 return `<span class="term" onclick="reveal(this)">${match}</span>`;
            });
            htmlBuilder += tempSentence + " ";
        });

        display.innerHTML = htmlBuilder;
        document.getElementById('workspace').style.display = 'block';
        ['blurBtn', 'quizBtn', 'saveBtn'].forEach(id => document.getElementById(id).disabled = false);
        
        // Reset Views
        isBlurred = false;
        document.getElementById('quizSection').style.display = 'none';
        updateBadge();
    }

    function generateQuiz() {
        const container = document.getElementById('quizContainer');
        const section = document.getElementById('quizSection');
        container.innerHTML = "";
        
        // Deduplicate facts
        const uniqueFacts = [...new Map(facts.map(f => [f.value, f])).values()];
        
        if(uniqueFacts.length < 3) return alert("Not enough facts found. Try more text.");

        // Pick 5 random questions
        const quizItems = uniqueFacts.sort(() => 0.5 - Math.random()).slice(0, 5);

        quizItems.forEach((item, idx) => {
            // SMART DISTRACTOR LOGIC
            // 1. Try to find other facts of the SAME TYPE (e.g. Year vs Year)
            let distractors = uniqueFacts
                .filter(f => f.type === item.type && f.value !== item.value)
                .map(f => f.value);
            
            // 2. If not enough same-type distractors, generate FAKE ones for numbers
            if(distractors.length < 3) {
                if(item.type === 'year') {
                    const yr = parseInt(item.value);
                    distractors.push((yr - 1).toString(), (yr + 2).toString(), (yr - 5).toString());
                } else if(item.type === 'percent') {
                    const p = parseFloat(item.value);
                    distractors.push((p + 10) + "%", (p - 5) + "%", (p / 2) + "%");
                } else {
                    // Fallback to other random text facts
                    distractors.push(...uniqueFacts.filter(f => f.value !== item.value).map(f => f.value));
                }
            }

            // 3. Final shuffle and slice
            distractors = [...new Set(distractors)].sort(() => 0.5 - Math.random()).slice(0, 3);
            while(distractors.length < 3) distractors.push("None of the above");

            const options = [...distractors, item.value].sort(() => 0.5 - Math.random());
            const questionText = item.sentence.replace(item.value, "__________");

            const card = document.createElement('div');
            card.className = 'quiz-card';
            card.innerHTML = `
                <p><strong>Q${idx+1}:</strong> ${questionText}</p>
                <div>
                    ${options.map(opt => `<button class="option-btn" onclick="checkAnswer(this, '${opt}', '${item.value}')">${opt}</button>`).join('')}
                </div>
            `;
            container.appendChild(card);
        });

        section.style.display = 'block';
        section.scrollIntoView({behavior: "smooth"});
    }

    // --- Helpers ---
    function checkAnswer(btn, selected, correct) {
        const btns = btn.parentElement.querySelectorAll('button');
        btns.forEach(b => b.disabled = true);
        if(selected === correct) btn.classList.add('correct');
        else {
            btn.classList.add('wrong');
            btns.forEach(b => { if(b.innerText === correct) b.classList.add('correct'); });
        }
    }

    function toggleBlur() {
        isBlurred = !isBlurred;
        const disp = document.getElementById('displayText');
        if(isBlurred) disp.classList.add('blur-active');
        else disp.classList.remove('blur-active');
        updateBadge();
    }

    function reveal(el) { if(isBlurred) { el.style.color = 'white'; el.style.backgroundColor = 'var(--success)'; } }
    function updateBadge() { document.getElementById('modeBadge').innerText = isBlurred ? "Recall Mode" : "Reading Mode"; }
    function showLoader(msg) { document.getElementById('loader').style.display='block'; document.getElementById('loader').innerText = "‚è≥ " + msg; }
    function hideLoader() { document.getElementById('loader').style.display='none'; }

    // --- Session Mgmt ---
    function saveSession() {
        const text = document.getElementById('inputText').value;
        if(!text) return;
        const sessions = JSON.parse(localStorage.getItem('sessions_v5') || '[]');
        sessions.unshift({ id: Date.now(), text: text, date: new Date().toLocaleDateString() });
        localStorage.setItem('sessions_v5', JSON.stringify(sessions));
        renderSessions();
        alert("Session Saved!");
    }
    
    function renderSessions() {
        const list = document.getElementById('sessionList');
        const sessions = JSON.parse(localStorage.getItem('sessions_v5') || '[]');
        list.innerHTML = sessions.map(s => `
            <div class="session-item" onclick="document.getElementById('inputText').value = \`${s.text.replace(/`/g, "\\`")}\`; processText(); switchTab('paste', document.querySelectorAll('.tab-btn')[0]);">
                <div><strong>Session</strong> <br><small>${s.date}</small></div>
                <span onclick="event.stopPropagation(); deleteSession(${s.id})" style="color:var(--danger)">√ó</span>
            </div>
        `).join('') || "<p style='color:gray; font-size:0.9rem'>No saved sessions.</p>";
    }
    
    function deleteSession(id) {
        let sessions = JSON.parse(localStorage.getItem('sessions_v5') || '[]');
        sessions = sessions.filter(s => s.id !== id);
        localStorage.setItem('sessions_v5', JSON.stringify(sessions));
        renderSessions();
    }

    renderSessions();
</script>

</body>
</html>